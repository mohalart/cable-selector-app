name: Create Folder Distribution with TTK Files

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-folder-distribution:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ttkbootstrap==1.10.1
        pip install pyinstaller==6.3.0
        
    - name: Fix locale issues in Python file
      run: |
        python -c "
        # Read the original file
        with open('2517126_project_final.py', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # Split into lines and fix locale issues
        lines = content.split('\n')
        fixed_lines = []
        skip_block = False
        
        for line in lines:
            if 'import locale' in line:
                continue
            elif '# try to set locale properly' in line:
                skip_block = True
                continue
            elif skip_block and line.strip() and not any(x in line for x in ['locale', '_candidate', 'try:', 'except', 'continue', 'for', 'break']):
                skip_block = False
                fixed_lines.append(line)
            elif not skip_block:
                fixed_lines.append(line)
        
        # Write fixed file
        with open('SmartCableSelector.py', 'w', encoding='utf-8') as f:
            f.write('\n'.join(fixed_lines))
        
        print('Fixed Python file created as SmartCableSelector.py')
        "
        
    - name: Create folder-based EXE
      run: |
        pyinstaller --onedir --windowed --name=SmartCableSelector --collect-all=ttkbootstrap --hidden-import=ttkbootstrap --hidden-import=ttkbootstrap.themes --clean --noconfirm SmartCableSelector.py
        
    - name: Verify build structure
      run: |
        Write-Host "Checking build structure..."
        if (Test-Path "dist\SmartCableSelector") {
          Write-Host "Folder distribution created!"
          Get-ChildItem "dist\SmartCableSelector" | Format-Table Name, Length
          
          if (Test-Path "dist\SmartCableSelector\SmartCableSelector.exe") {
            Write-Host "Main executable found!"
            $size = (Get-Item "dist\SmartCableSelector\SmartCableSelector.exe").Length / 1MB
            Write-Host "EXE Size: $([math]::Round($size, 1)) MB"
          }
          
          $ttkFiles = Get-ChildItem "dist\SmartCableSelector" -Recurse -Filter "*ttk*" | Measure-Object
          Write-Host "Found $($ttkFiles.Count) ttkbootstrap-related files"
          
        } else {
          Write-Host "Folder distribution failed!"
          exit 1
        }
        
    - name: Create distribution package
      run: |
        Write-Host "Creating distribution package..."
        New-Item -ItemType Directory -Path "SmartCableSelector_Distribution" -Force
        Copy-Item -Path "dist\SmartCableSelector\*" -Destination "SmartCableSelector_Distribution" -Recurse
        
    - name: Create run script
      run: |
        echo "@echo off" > SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "echo Starting Smart Cable Selector..." >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "echo." >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "SmartCableSelector.exe" >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "if errorlevel 1 (" >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "    echo." >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "    echo Error: Application failed to start" >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "    echo Please make sure all files are in the same folder" >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo "    pause" >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        echo ")" >> SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat
        
    - name: Create README
      run: |
        echo "SMART CABLE SELECTOR - PORTABLE DISTRIBUTION" > SmartCableSelector_Distribution\README.txt
        echo "==========================================" >> SmartCableSelector_Distribution\README.txt
        echo "" >> SmartCableSelector_Distribution\README.txt
        echo "CONTENTS:" >> SmartCableSelector_Distribution\README.txt
        echo "- SmartCableSelector.exe - Main application" >> SmartCableSelector_Distribution\README.txt
        echo "- RUN_CABLE_SELECTOR.bat - Easy startup script" >> SmartCableSelector_Distribution\README.txt
        echo "- _internal/ - Required libraries and dependencies" >> SmartCableSelector_Distribution\README.txt
        echo "- ttkbootstrap themes and files" >> SmartCableSelector_Distribution\README.txt
        echo "" >> SmartCableSelector_Distribution\README.txt
        echo "HOW TO RUN:" >> SmartCableSelector_Distribution\README.txt
        echo "1. Double-click 'RUN_CABLE_SELECTOR.bat'" >> SmartCableSelector_Distribution\README.txt
        echo "   OR" >> SmartCableSelector_Distribution\README.txt
        echo "2. Double-click 'SmartCableSelector.exe' directly" >> SmartCableSelector_Distribution\README.txt
        echo "" >> SmartCableSelector_Distribution\README.txt
        echo "REQUIREMENTS:" >> SmartCableSelector_Distribution\README.txt
        echo "- Windows 7 or newer" >> SmartCableSelector_Distribution\README.txt
        echo "- No Python installation required" >> SmartCableSelector_Distribution\README.txt
        echo "- Keep all files in the same folder" >> SmartCableSelector_Distribution\README.txt
        echo "" >> SmartCableSelector_Distribution\README.txt
        echo "Created by: Ata Turk - 2025" >> SmartCableSelector_Distribution\README.txt
        
    - name: Verify final package
      run: |
        Write-Host "Final package verification..."
        $folderSize = (Get-ChildItem "SmartCableSelector_Distribution" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host "Total package size: $([math]::Round($folderSize, 1)) MB"
        
        Write-Host "Package contents:"
        Get-ChildItem "SmartCableSelector_Distribution" | Format-Table Name, Length
        
        if (Test-Path "SmartCableSelector_Distribution\SmartCableSelector.exe") {
          Write-Host "Main executable: OK"
        }
        if (Test-Path "SmartCableSelector_Distribution\RUN_CABLE_SELECTOR.bat") {
          Write-Host "Run script: OK"
        }
        if (Test-Path "SmartCableSelector_Distribution\README.txt") {
          Write-Host "README: OK"
        }
        if (Test-Path "SmartCableSelector_Distribution\_internal") {
          Write-Host "Dependencies folder: OK"
        }
        
    - name: Create ZIP package
      run: |
        Write-Host "Creating ZIP package for download..."
        Compress-Archive -Path "SmartCableSelector_Distribution\*" -DestinationPath "SmartCableSelector_Portable.zip" -Force
        
        $zipSize = (Get-Item "SmartCableSelector_Portable.zip").Length / 1MB
        Write-Host "ZIP created: $([math]::Round($zipSize, 1)) MB"
        
    - name: Upload portable distribution
      uses: actions/upload-artifact@v4
      with:
        name: SmartCableSelector-Portable-Distribution
        path: SmartCableSelector_Portable.zip
        retention-days: 30
